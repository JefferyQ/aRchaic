---
title: ""
output:
  html_document:
    toc_float: 
      collapsed: true
      smooth_scroll: true
---

![.](logo_design.svg)

## Introduction 

**aRchaic** is a R/python software environment that performs model based 
clustering and visualization of ancient and modern DNA samples from one or more 
studies (see `plot_archaic()` section for example visualization). 
This model can be used to identify distinct patterns of DNA damage and
is capable of reflecting relative rates of contamination in contaminated aDNA
samples. 

## Installation

First and foremost, the user is required to install 
[python](https://www.python.org/downloads/) and 
[R/RStudio](https://www.rstudio.com/). Next, the user needs to install the Python packages 
[pysam](http://pysam.readthedocs.io/en/latest/installation.html) and
[pyfaidx](https://pythonhosted.org/pyfaidx/#installation).

Start a new R session and install the R dependency libraries.

```{r echo=TRUE, eval = FALSE}
install.packages("devtools")
devtools::install_github("TaddyLab/maptpx")
devtools::install_github("kkdey/CountClust")
install.packages("ggplot2")
install.packages("dplyr")
install.packages("plyr")
source("https://bioconductor.org/biocLite.R")
biocLite("Logolas")
```

On completion of the above steps, install the R package **aRchaic**

```{r echo=TRUE, eval=FALSE}
devtools::install_github("kkdey/aRchaic")
```

Load aRchaic into R

```{r}
library(aRchaic)
```


## aRchaic input - MFF file

For every mismatch in a BAM file with respect to a reference genome, **aRchaic**
records various features of the mismatch - mismatch type, flanking bases,
strand break base, strand and position of mismatch from the ends of read - into 
a .csv file which we call the *Mismatch Feature Format (MFF)* file. 

A typical example MFF file looks like the following 

```{r}
mff <- read.csv(system.file("extdata","ancients","NE2_subsampled.csv",package = "aRchaic"),
                header = FALSE)
head(mff)
```

The first column represents mismatch type and flanking bases :
(left flank base)(mismatch)(right flank base) <-> (A)(C->T)(C).
The second and third columns represent the position of mismatch from 5' and 3' ends
of reads after mapped to reference. The 4th (5th) columns represent the base
1 base upstream (downstream) from 5' (3') end of read 
respectively. The 6th column contains information of which strand the read comes
from, and the 7th column is an identifier for the read containing the mismatch.

We provide scripts to generate the MFF files from the BAM/SAM files
[here](https://github.com/kkdey/aRchaic/tree/master/bin). The simple one line 
code to use for indexed BAM file is 

```{r, eval=FALSE}
python generate_summary_bams.py -b /path/to/bam/example.bam -f /path/to/reference/hs37d5
.fa -o /path/to/mff/example_mff.csv --add-chr
```


## prepare_archaic()

Suppose you have multiple folders of MFF files corresponding to different studies - 
comprising of ancient and/or modern samples. 
We present an example here where we incorporate two folders like
that in the package - `inst/extdata/moderns` and `inst/extdata/ancients`
corresponding to separate studies for 5 moderns and 5 ancients. 

- **Modern study** :

```{r}
moderns_dir <- system.file("extdata","moderns", package = "aRchaic")
list.files(moderns_dir, pattern = ".csv")
```

- **Ancient study** :

```{r}
ancients_dir <- system.file("extdata","ancients", package = "aRchaic")
list.files(ancients_dir, pattern = ".csv")
```

Each of the folders has 5 MFF files corresponding to 5 samples. 

Next we prepare the input data to **aRchaic** model from the above data folders.

```{r warning = FALSE, message = FALSE}
out <- prepare_archaic(dirs = c(moderns_dir, ancients_dir))
```

The output `out` should be a list with 2 elements - corresponding to 2 study 
folders. Each element is a matrix with samples along the rows, coded 
mismatch features along columns, and a cell in the matrix record counts 
of the number of times a coded mismatch pattern occurs in a sample. 

## model_archaic() 

**aRchaic** fits a mixed membership  model on the prepared 
mismatch feature data from `prepare_archaic()`  that allows each sample to 
have partial memberships in more than one cluster 
where the clusters represent distinct mismatch feature profiles. 

We first choose a directory - `output_dir` - to save the model output and 
visualization.

Next we run the `model_archaic` function to fit the mixed membership model.
We choose the number of clusters $K=2$

```{r}
output_dir <- system.file("extdata","archaic_results", package = "aRchaic")
model <- model_archaic(out, K = 2, output_dir = output_dir)
```

the output `model` consists of 

- **omega** : the grades of membership to be plotted by stacked bar chart
- **theta** : cluster profiles - with each column a probability distribution on
          coded mismatch features 
- **assessment** : assessment of model fit : BIC and loglikelihood


## plot_archaic()

The model output, in particular **omega** and **theta** can be visualized using 
the `plot_archaic()` command.

```{r warning = FALSE, message = FALSE, eval=FALSE}
plot_archaic(model, output_dir = output_dir, background = "modern")
```

Once the run finishes (a few seconds), go to the output directory `output_dir`. 
You should see there is a `structure.png` file that represents the cluster
memberships in **omega** in a stacked bar chart (see Fig 1 left).

Also, the `output_dir` should contain for each $k=1,2$, a `logo_clus_k.png` file
visualizing the mismatch profile for each cluster as in **theta**. If
`background = "modern"` in `plot_archaic` code above, this reresentation will
plot enrichment of the mismatch profiles with respect to a modern background.

The following is a summary of these visualizations

<div style="width:750px; height:750px">
![](vignette_fig.png)
</div>

## SessionInfo

```{r}
sessionInfo()
```
